<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pacing Timer</title>
    <!--
        Pacing Study Timer
        
        This single-file application provides a per-page study timer to help users pace their work.
        
        Algorithm & State Model Summary:
        The application operates on a core state model that tracks total pages, total time, and the remaining
        pools of each.
        
        1.  Initial State: The user provides `totalPages` and `totalTime` (in minutes). This is converted
            to `totalTimeSec`. The `remainingPages` and `remainingTimePoolSec` are initialized.
        
        2.  Per-Page Allocation: When a page starts (either the first or after clicking "Next"), a
            `currentAllocSec` is calculated by dividing the `remainingTimePoolSec` by `remainingPages`.
            This ensures the remaining time is perfectly balanced across the remaining work.
        
        3.  Timer Tick: A `setInterval` runs every second, decrementing `currentRemainingSec`. The UI,
            including a circular SVG progress ring, is updated with each tick. If the timer hits zero,
            it enters an "overtime" state, counting upwards.
        
        4.  "Next" Action: When the user clicks "Next", the timer stops. The `actualTimeUsedSec` for the
            completed page is calculated and subtracted from `remainingTimePoolSec`. `remainingPages` is
            decremented. A new allocation is calculated for the next page, and the timer restarts.
        
        5.  Completion: When all pages are complete, a summary view is shown with detailed statistics
            about the session, including time saved or overtime accrued.
        
        State Variables:
        - totalPages: Initial number of pages.
        - totalTimeSec: Initial total time in seconds.
        - remainingPages: Countdown of pages left.
        - remainingTimePoolSec: Pool of available seconds, re-distributed each page.
        - currentPageIndex: 1-based index of the current page.
        - currentAllocSec: The time allocated for the current page when it started.
        - currentRemainingSec: The live countdown timer for the current page.
        - timerState: Manages UI changes ("running", "overtime", "stopped").
        - tickInterval: The reference to the setInterval for the timer.
        - perPageRecords: An array storing the actual time used for each page.
    -->
    <style>
        :root {
            --bg-light: #f8fafc;
            --card-bg: #ffffff;
            --text-dark: #0f172a;
            --text-light: #64748b;
            --accent-primary: #06b6d4; /* Teal */
            --accent-primary-dark: #0891b2;
            --accent-secondary: #e2e8f0;
            --accent-secondary-dark: #cbd5e1;
            --danger: #e11d48;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --font-sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg-light);
            color: var(--text-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .hidden {
            display: none !important;
        }

        .main-card {
            background-color: var(--card-bg);
            border-radius: 1rem;
            box-shadow: var(--shadow);
            padding: 2.5rem;
            width: 100%;
            max-width: 800px;
        }
        
        /* --- Setup Screen --- */
        #setup-screen {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        #setup-screen h1 {
            font-size: 1.875rem;
            font-weight: 700;
            text-align: center;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .input-group label {
            font-weight: 500;
            color: var(--text-light);
        }
        .input-group input {
            font-size: 1rem;
            padding: 0.75rem 1rem;
            border: 1px solid var(--accent-secondary-dark);
            border-radius: 0.5rem;
            width: 100%;
        }
        .input-group input:focus {
            outline: 2px solid var(--accent-primary);
            border-color: transparent;
        }
        .validation-error {
            color: var(--danger);
            font-size: 0.875rem;
            min-height: 1.25rem;
        }

        /* --- Timer Screen --- */
        #timer-screen {
            display: flex;
            gap: 2.5rem;
            align-items: center;
        }

        .timer-display {
            flex-shrink: 0;
            position: relative;
            width: 300px;
            height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .timer-display-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: var(--card-bg);
            box-shadow: inset 0 2px 4px rgb(0 0 0 / 0.06);
        }

        .timer-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-ring-track {
            stroke: var(--accent-secondary);
            stroke-width: 12;
            fill: transparent;
        }

        .progress-ring-indicator {
            stroke: var(--accent-primary);
            stroke-width: 12;
            fill: transparent;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s linear, stroke 0.3s linear;
        }

        .timer-content {
            position: relative;
            text-align: center;
            z-index: 10;
        }

        #main-timer {
            font-family: var(--font-mono);
            font-size: 4.5rem; /* 72px */
            line-height: 1;
            color: var(--text-dark);
            transition: color 0.3s ease;
        }

        #overtime-label {
            font-weight: 600;
            color: var(--danger);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.875rem;
        }

        .timer-alloc-info {
            margin-top: 1rem;
            color: var(--text-light);
            font-size: 0.875rem;
            text-align: center;
        }

        .controls-stats {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        #page-header {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .progress-bar-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        #page-progress-bar {
            width: 100%;
            height: 0.5rem;
            -webkit-appearance: none;
            appearance: none;
            border: none;
            border-radius: 9999px;
            overflow: hidden;
            background-color: var(--accent-secondary);
        }
        #page-progress-bar::-webkit-progress-bar { background-color: var(--accent-secondary); }
        #page-progress-bar::-webkit-progress-value { background-color: var(--accent-primary); transition: width 0.3s ease; }
        #page-progress-bar::-moz-progress-bar { background-color: var(--accent-primary); transition: width 0.3s ease; }


        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .stat-item {
            background-color: var(--bg-light);
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .stat-item-label {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }
        .stat-item-value {
            font-size: 1.25rem;
            font-weight: 600;
            font-family: var(--font-mono);
        }
        .deficit {
            color: var(--danger);
        }

        .keyboard-hint {
            font-size: 0.875rem;
            color: var(--text-light);
            text-align: center;
        }
        
        /* --- Summary Screen --- */
        #summary-screen {
             text-align: center;
        }
        #summary-screen h2 {
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 2rem;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            text-align: left;
            margin-bottom: 2.5rem;
        }
        .summary-stat-item {
             background-color: var(--bg-light);
             padding: 1rem;
             border-radius: 0.75rem;
        }
        .summary-stat-item .label {
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }
        .summary-stat-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: var(--font-mono);
        }

        /* --- Buttons --- */
        .btn {
            font-size: 1rem;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        .btn:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        .btn-primary {
            background-color: var(--accent-primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--accent-primary-dark);
        }

        .btn-secondary {
            background-color: var(--accent-secondary);
            color: var(--text-light);
        }
        .btn-secondary:hover {
            background-color: var(--accent-secondary-dark);
        }

        .actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        #next-btn {
            width: 100%;
            padding-top: 1rem;
            padding-bottom: 1rem;
            font-size: 1.125rem;
        }

        /* --- Overtime State --- */
        .timer-display.overtime #main-timer {
            color: var(--danger);
        }
        .timer-display.overtime .progress-ring-indicator {
            stroke: var(--danger);
        }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            body {
                align-items: flex-start;
                padding: 0.5rem;
            }
            .main-card {
                padding: 1.5rem;
            }
            #timer-screen {
                flex-direction: column;
                gap: 2rem;
            }
            .timer-display {
                width: 260px;
                height: 260px;
            }
            #main-timer {
                font-size: 3.75rem; /* 60px */
            }
            .controls-stats {
                width: 100%;
            }
            .summary-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <main class="main-card">
        <!-- Setup Screen -->
        <section id="setup-screen">
            <h1>Pacing Timer</h1>
            <div class="input-group">
                <label for="total-pages">Total pages</label>
                <input type="number" id="total-pages" min="1" placeholder="e.g., 30">
                <p class="validation-error" id="pages-error"></p>
            </div>
            <div class="input-group">
                <label for="total-time">Total time (minutes)</label>
                <input type="number" id="total-time" min="1" placeholder="e.g., 180">
                <p class="validation-error" id="time-error"></p>
            </div>
            <div class="actions">
                <button id="start-btn" class="btn btn-primary">Start Session</button>
            </div>
        </section>

        <!-- Timer Screen -->
        <section id="timer-screen" class="hidden">
            <div class="timer-display" id="timer-display-wrapper">
                <div class="timer-display-circle"></div>
                <svg class="timer-svg" viewBox="0 0 100 100">
                    <circle class="progress-ring-track" cx="50" cy="50" r="45"></circle>
                    <circle id="progress-ring" class="progress-ring-indicator" cx="50" cy="50" r="45"></circle>
                </svg>
                <div class="timer-content">
                    <time id="main-timer" datetime="PT00M00S" role="status" aria-live="polite">00:00</time>
                    <div id="overtime-label" class="hidden">LATE</div>
                </div>
                <div class="timer-alloc-info">
                    Allocated: <span id="current-alloc-display">00:00</span>
                </div>
            </div>

            <div class="controls-stats">
                <h2 id="page-header">Page 1 of 10</h2>
                
                <div class="progress-bar-container">
                    <label for="page-progress-bar" class="sr-only">Session Progress</label>
                    <progress id="page-progress-bar" value="0" max="100"></progress>
                    <div id="progress-text" class="text-light" style="font-size: 0.875rem; text-align: right;">Completed: 0 / 10 (0%)</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-item-label">Remaining time pool</div>
                        <div id="remaining-pool-display" class="stat-item-value">0:00:00</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">Avg per remaining</div>
                        <div id="avg-remaining-display" class="stat-item-value">00:00</div>
                    </div>
                </div>

                <div class="actions">
                    <button id="next-btn" class="btn btn-primary" aria-label="Next page">Next</button>
                    <button id="abort-btn" class="btn btn-secondary" aria-label="Abort session">Abort</button>
                </div>
                
                <p class="keyboard-hint">Press <kbd>N</kbd> for Next, <kbd>Esc</kbd> to Abort</p>
            </div>
        </section>

        <!-- Summary Screen -->
        <section id="summary-screen" class="hidden">
            <h2>Session Complete!</h2>
            <div class="summary-stats">
                <div class="summary-stat-item">
                    <div class="label">Pages completed</div>
                    <div id="summary-pages" class="value">0</div>
                </div>
                <div class="summary-stat-item">
                    <div class="label">Total time allocated</div>
                    <div id="summary-allocated" class="value">0:00:00</div>
                </div>
                 <div class="summary-stat-item">
                    <div class="label">Total time used</div>
                    <div id="summary-used" class="value">0:00:00</div>
                </div>
                 <div class="summary-stat-item">
                    <div class="label">Cumulative saved time</div>
                    <div id="summary-saved" class="value">0:00:00</div>
                </div>
                <div class="summary-stat-item">
                    <div class="label">Cumulative overtime</div>
                    <div id="summary-overtime" class="value">0:00:00</div>
                </div>
            </div>
            <div class="actions">
                <button id="restart-btn" class="btn btn-primary">Restart</button>
                <button id="new-session-btn" class="btn btn-secondary">New Session</button>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', initApp);

        // --- DOM Element References ---
        const dom = {
            setupScreen: document.getElementById('setup-screen'),
            timerScreen: document.getElementById('timer-screen'),
            summaryScreen: document.getElementById('summary-screen'),
            totalPagesInput: document.getElementById('total-pages'),
            totalTimeInput: document.getElementById('total-time'),
            pagesError: document.getElementById('pages-error'),
            timeError: document.getElementById('time-error'),
            startBtn: document.getElementById('start-btn'),
            nextBtn: document.getElementById('next-btn'),
            abortBtn: document.getElementById('abort-btn'),
            restartBtn: document.getElementById('restart-btn'),
            newSessionBtn: document.getElementById('new-session-btn'),
            mainTimer: document.getElementById('main-timer'),
            overtimeLabel: document.getElementById('overtime-label'),
            timerDisplayWrapper: document.getElementById('timer-display-wrapper'),
            pageHeader: document.getElementById('page-header'),
            progressBar: document.getElementById('page-progress-bar'),
            progressText: document.getElementById('progress-text'),
            remainingPoolDisplay: document.getElementById('remaining-pool-display'),
            avgRemainingDisplay: document.getElementById('avg-remaining-display'),
            currentAllocDisplay: document.getElementById('current-alloc-display'),
            progressRing: document.getElementById('progress-ring'),
            // Summary elements
            summaryPages: document.getElementById('summary-pages'),
            summaryAllocated: document.getElementById('summary-allocated'),
            summaryUsed: document.getElementById('summary-used'),
            summarySaved: document.getElementById('summary-saved'),
            summaryOvertime: document.getElementById('summary-overtime'),
        };

        // --- State Management ---
        const state = {
            totalPages: 0,
            totalTimeSec: 0,
            remainingPages: 0,
            remainingTimePoolSec: 0,
            currentPageIndex: 0,
            currentAllocSec: 0,
            currentRemainingSec: 0,
            timerState: 'stopped', // "running", "overtime", "stopped"
            tickInterval: null,
            perPageRecords: [],
        };
        
        const ringConfig = {
            radius: 45,
            circumference: 2 * Math.PI * 45,
        };

        // --- Initialization ---
        function initApp() {
            dom.startBtn.addEventListener('click', () => {
                const pages = parseInt(dom.totalPagesInput.value, 10);
                const minutes = parseInt(dom.totalTimeInput.value, 10);
                startSession(pages, minutes);
            });
            dom.nextBtn.addEventListener('click', handleNext);
            dom.abortBtn.addEventListener('click', abortSession);
            dom.restartBtn.addEventListener('click', () => {
                 startSession(state.totalPages, state.totalTimeSec / 60);
            });
            dom.newSessionBtn.addEventListener('click', resetToSetup);

            document.addEventListener('keydown', handleKeyPress);
            
            dom.progressRing.style.strokeDasharray = ringConfig.circumference;
        }

        // --- Core Session Logic ---
        function startSession(totalPages, totalMinutes) {
            // Input validation
            let isValid = true;
            dom.pagesError.textContent = '';
            dom.timeError.textContent = '';
            if (isNaN(totalPages) || totalPages < 1) {
                dom.pagesError.textContent = 'Enter pages ≥ 1';
                isValid = false;
            }
            if (isNaN(totalMinutes) || totalMinutes < 1) {
                dom.timeError.textContent = 'Enter minutes ≥ 1';
                isValid = false;
            }
            if (!isValid) return;

            // Initialize state
            state.totalPages = totalPages;
            state.totalTimeSec = totalMinutes * 60;
            state.remainingPages = totalPages;
            state.remainingTimePoolSec = state.totalTimeSec;
            state.currentPageIndex = 1;
            state.perPageRecords = [];
            
            // Switch views
            dom.setupScreen.classList.add('hidden');
            dom.summaryScreen.classList.add('hidden');
            dom.timerScreen.classList.remove('hidden');

            startPage();
        }

        function startPage() {
            if (state.remainingPages <= 0) return;

            // Calculate allocation for the current page
            state.currentAllocSec = state.remainingTimePoolSec / state.remainingPages;
            state.currentRemainingSec = Math.max(0, Math.round(state.currentAllocSec));
            
            state.timerState = 'running';
            
            updateStaticUI();
            updateLiveUI();
            
            if (state.tickInterval) clearInterval(state.tickInterval);
            state.tickInterval = setInterval(tick, 1000);
        }

        function tick() {
            state.currentRemainingSec -= 1;
            
            if (state.currentRemainingSec < 0 && state.timerState === 'running') {
                state.timerState = 'overtime';
            }
            updateLiveUI();
        }

        function handleNext() {
            if (state.tickInterval) clearInterval(state.tickInterval);

            // Record time used for the page
            let actualTimeUsedSec;
            if (state.currentRemainingSec >= 0) {
                actualTimeUsedSec = state.currentAllocSec - state.currentRemainingSec;
            } else { // Overtime
                actualTimeUsedSec = state.currentAllocSec + Math.abs(state.currentRemainingSec);
            }
            state.perPageRecords.push(actualTimeUsedSec);
            
            // Update state for next page
            state.remainingTimePoolSec -= actualTimeUsedSec;
            state.remainingPages -= 1;
            
            if (state.remainingPages > 0) {
                state.currentPageIndex += 1;
                startPage();
            } else {
                showSummary();
            }
        }
        
        function abortSession() {
            // A confirm dialog is avoided as per requirements.
            // A custom modal could be added here for a better UX.
            resetToSetup();
        }
        
        function resetToSetup() {
            if (state.tickInterval) clearInterval(state.tickInterval);
            
            // Reset state object
            Object.assign(state, {
                totalPages: 0,
                totalTimeSec: 0,
                remainingPages: 0,
                remainingTimePoolSec: 0,
                currentPageIndex: 0,
                currentAllocSec: 0,
                currentRemainingSec: 0,
                timerState: 'stopped',
                tickInterval: null,
                perPageRecords: [],
            });
            
            // Reset UI
            dom.totalPagesInput.value = '';
            dom.totalTimeInput.value = '';
            dom.pagesError.textContent = '';
            dom.timeError.textContent = '';

            dom.timerScreen.classList.add('hidden');
            dom.summaryScreen.classList.add('hidden');
            dom.setupScreen.classList.remove('hidden');
        }

        // --- UI Update Functions ---
        function updateStaticUI() {
            dom.pageHeader.textContent = `Page ${state.currentPageIndex} of ${state.totalPages}`;
            
            const completedPages = state.currentPageIndex - 1;
            const progressPercent = state.totalPages > 0 ? (completedPages / state.totalPages) * 100 : 0;
            dom.progressBar.value = progressPercent;
            dom.progressBar.setAttribute('aria-valuenow', progressPercent);
            dom.progressBar.setAttribute('aria-valuemin', 0);
            dom.progressBar.setAttribute('aria-valuemax', 100);
            
            dom.progressText.textContent = `Completed: ${completedPages} / ${state.totalPages} (${Math.round(progressPercent)}%)`;
            
            const avgRemaining = state.remainingPages > 0 ? state.remainingTimePoolSec / state.remainingPages : 0;
            dom.avgRemainingDisplay.textContent = formatMMSS(avgRemaining > 0 ? avgRemaining : 0);
            
            dom.currentAllocDisplay.textContent = formatMMSS(state.currentAllocSec > 0 ? state.currentAllocSec : 0);
        }

        function updateLiveUI() {
            // Update main timer
            const secondsToDisplay = state.timerState === 'overtime' ? Math.abs(state.currentRemainingSec) : state.currentRemainingSec;
            const formattedTime = formatMMSS(secondsToDisplay);
            dom.mainTimer.textContent = state.timerState === 'overtime' ? `+${formattedTime}` : formattedTime;
            dom.mainTimer.setAttribute('datetime', `PT${Math.floor(Math.abs(secondsToDisplay) / 60)}M${Math.abs(secondsToDisplay) % 60}S`);

            // Update overtime indicators
            if (state.timerState === 'overtime') {
                dom.timerDisplayWrapper.classList.add('overtime');
                dom.overtimeLabel.classList.remove('hidden');
            } else {
                dom.timerDisplayWrapper.classList.remove('overtime');
                dom.overtimeLabel.classList.add('hidden');
            }
            
            // Update remaining pool
            dom.remainingPoolDisplay.textContent = formatHMSFull(state.remainingTimePoolSec);
            dom.remainingPoolDisplay.classList.toggle('deficit', state.remainingTimePoolSec < 0);

            // Update progress ring
            const progress = state.currentRemainingSec >= 0 && state.currentAllocSec > 0
                ? state.currentRemainingSec / state.currentAllocSec
                : 0;
            const clampedProgress = Math.max(0, Math.min(1, progress));
            const offset = ringConfig.circumference * (1 - clampedProgress);
            dom.progressRing.style.strokeDashoffset = offset;
        }

        function showSummary() {
            dom.timerScreen.classList.add('hidden');
            dom.summaryScreen.classList.remove('hidden');

            const totalUsedSec = state.perPageRecords.reduce((sum, current) => sum + current, 0);
            const timeDifference = state.totalTimeSec - totalUsedSec;

            dom.summaryPages.textContent = `${state.totalPages} / ${state.totalPages}`;
            dom.summaryAllocated.textContent = formatHMSFull(state.totalTimeSec);
            dom.summaryUsed.textContent = formatHMSFull(totalUsedSec);
            dom.summarySaved.textContent = formatHMSFull(Math.max(0, timeDifference));
            dom.summaryOvertime.textContent = formatHMSFull(Math.max(0, -timeDifference));
        }


        // --- Utility & Event Handlers ---
        function formatMMSS(totalSeconds) {
            const absSeconds = Math.abs(Math.round(totalSeconds));
            const minutes = Math.floor(absSeconds / 60);
            const seconds = absSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function formatHMSFull(totalSeconds) {
            const isNegative = totalSeconds < 0;
            const absSeconds = Math.abs(Math.round(totalSeconds));
            const hours = Math.floor(absSeconds / 3600);
            const minutes = Math.floor((absSeconds % 3600) / 60);
            const seconds = absSeconds % 60;
            
            const hmsString = `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            return isNegative ? `-${hmsString}` : hmsString;
        }

        function handleKeyPress(event) {
            if (dom.timerScreen.classList.contains('hidden')) return;

            if (event.key.toLowerCase() === 'n') {
                dom.nextBtn.click();
            } else if (event.key === 'Escape') {
                dom.abortBtn.click();
            }
        }
    </script>
</body>
</html>
